import OpenAI from 'openai';
export async function POST(request: Request) {

    
    const AI_MODEL = 'x-ai/grok-4-fast-thinking';
    const { vacancy, resume } = await request.json();
    const BASE_URL = "https://api.vsegpt.ru/v1"
    const TEMPERATURE = 0.3;
    const formatAIResponse = (text: string) => {
      if (!text) return '';
      
      let formatted = text
        // Заголовки (### Заголовок → <h3>Заголовок</h3>)
        .replace(/### (.*?)(?:\n|$)/g, '<h3>$1</h3>')
        // Подзаголовки (#### Подзаголовок → <h4>Подзаголовок</h4>)
        .replace(/#### (.*?)(?:\n|$)/g, '<h4>$1</h4>')
        // Жирный текст (**текст** → <strong>текст</strong>)
        .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
        // Курсив (*текст* → <em>текст</em>)
        .replace(/\*(.*?)\*/g, '<em>$1</em>')
        // Маркированные списки (- пункт → <li>пункт</li>)
        .replace(/^- (.*?)(?:\n|$)/gm, '<li>$1</li>')
        // Нумерованные списки (1. пункт → <li>пункт</li>)
        .replace(/^\d+\. (.*?)(?:\n|$)/gm, '<li>$1</li>')
        // Переносы строк → параграфы
        .split('\n\n')
        .map((paragraph: string) => {
          if (paragraph.startsWith('<h3>') || paragraph.startsWith('<h4>') || 
              paragraph.startsWith('<li>') || paragraph.includes('<li>')) {
            return paragraph;
          }
          return paragraph.trim() ? `<p>${paragraph.trim()}</p>` : '';
        })
        .join('')
        // Оборачиваем списки в <ul> (без флага s, используем [\s\S] вместо .)
        .replace(/(<li>[\s\S]*?<\/li>)/g, '<ul>$1</ul>');
    
      return formatted;
    };
    // Проверка на наличие данных
    if (!vacancy || !resume) {
      return Response.json(
        { error: 'Заполните все поля' }, 
        { status: 400 }
      );
    };

    const API_KEY = process.env.VSE_GPT_API_KEY;
    
    if (!API_KEY) {
      return Response.json(
        { error: 'API не настроено' },
        { status: 500 }
      );
    };

    const openai = new OpenAI({
      baseURL: BASE_URL,
      apiKey: process.env.VSE_GPT_API_KEY
    });
    const system_prompt = `
    1. Роль и задача
    Ты — эксперт по карьерному консультированию и оптимизации резюме. 
    Твоя главная задача — творчески и тщательно адаптировать резюме пользователя под конкретную вакансию,
    чтобы максимально повысить его релевантность, привлекательность для HR и шансы на прохождение ATS 
    (системы автоматического отслеживания кандидатов).

    2. Ключевые принципы работы

        Принцип достоверности (НЕПРЕРЕКАЕМ): Запрещено добавлять неправдивую информацию. Нельзя придумывать:

            Новый опыт работы, должности, компании или проекты.

            Новое образование, сертификаты или награды.

            Количественные показатели (цифры, проценты, сроки), которых нет в исходном резюме.

            Нельзя переименовывать то, что переименовывать нелогично, например, наименование университета, курса, образования.
            Можно переформулировать роль в компании (например, не старший консультант, а старший аналитик), если это улучшит шанс пройти ATS скрининг

        Принцип гибкости для быстрых навыков: Разрешено добавлять в раздел "Навыки" технологии/инструменты, отсутствующие в исходном резюме, ЕСЛИ:

            Этот навык явно требуется или желателен в вакансии

            Это инструмент/технология базового уровня, которую можно освоить на начальном уровне за 2-4 недели самостоятельного изучения

            У пользователя есть смежные навыки, которые позволяют быстро освоить этот инструмент

        Принцип максимальной релевантности: Твоя цель — переосмыслить, переформулировать и переупаковать существующий опыт пользователя так,
         чтобы он идеально соответствовал языку и требованиям вакансии.

        Принцип прозрачности изменений: Все ключевые изменения должны быть явно показаны пользователю.

    3. Входные данные
    Ты получишь два документа:

        Резюме (CV): Текущее резюме пользователя.

        Описание вакансии (Job Description): Текст вакансии, на которую пользователь хочет откликнуться.

    4. Пошаговый алгоритм действий

    Шаг 1: Глубокий анализ

        Внимательно изучи оба документа.

        Выдели из вакансии ключевые слова: обязательные требования, желательные навыки, мягкие навыки, отраслевая и техническая терминология.

        Определи "быстрые навыки": Отметь навыки из вакансии, которые отсутствуют в резюме, но могут быть быстро освоены на базовом уровне.

    Шаг 2: Стратегическое планирование

        Определи, какие разделы резюме требуют наибольшей адаптации.

        Наметь конкретные изменения: какие формулировки улучшить, какие навыки перегруппировать, что добавить.

        Прими решение о добавлении "быстрых навыков" согласно принципу гибкости.

    Шаг 3: Активная адаптация и реструктуризация

        Профессиональное резюме / Карьерная цель: Если такой блок или похожий есть - перепиши с акцентом на ключевые требования вакансии.

        Опыт работы: Переформулируй пункты, используя глаголы действия и ключевые слова. Расставь в порядке релевантности.

        Другие разделы: Адаптируй при наличии прямой связи с вакансией.

        Учти, что не стоит везде дописывать ключевые слова и навыки. Тебе нужно увеличить немного количество ключевых слов, чтобы ATS оценил резюме чучуть лучше.
        Не пиши их там, их вставка может только навредить (дополнительные вопросы на интервью, впечатление, что резюме подогнали под вакансию). 

        Избегай, если возможно, корпоративного жаргона и лишнего пафоса, не используй слова, которые звучат профессионально,
        но которые по сути ничего не значат. Например, используй "образ" или "бренд" вместо "айдентика". 
        Будь скромным, практичным скептиком.

        Не меняй структуру блоков резюме. Пользователю должно быть удобно ориентироваться в существующей структуре резюме. 
        Также часто будут резюме с платформ для поиска работы. Там невозможно поменять порядок блоков - только информацию внутри. 

    5. Формат вывода

    Ты должен предоставить:

    Отформатируй резюме используя ТОЛЬКО эти три простые метки:

    [[+текст]] - для нового текста
    [[~текст→текст]] - для измененного текста  
    [[^текст]] - для текста, который поменял порядок

    ПРАВИЛА:
    1. Используй только эти три формата
    2. Не добавляй пояснений
    3. Не меняй основной текст, только добавляй метки
    4. Все метки должны быть точно в таком формате

    Пример:
    Было: "Налоговый консультант"
    Стало: "[[~Налоговый консультант→Бизнес Аналитик]]"

    В ответе только текст резюме с метками.

    6. Критически важные напоминания

        НЕ ВРИ о фундаментальном опыте. Добавленные "быстрые навыки" не должны создавать ложного впечатления о профессиональном опыте работы.

        Будь смелым в формулировках в рамках допустимого.

        Язык вакансии — твой язык. Максимально используй термины из описания вакансии.

        Подсветка должна быть полезной, но не загромождать текст.
    `
    const recommendations_prompt =`
    Ты адаптировала резюме под вакансию. В резюме появились новые формулировки и изменения. 

    1. Очень кратко опиши, какие изменения и зачем ты внесла. Не нужно пояснять, какими символами пометила изменение - пользователь видит, что поменялось.
    2. Приведи очень краткий, структурированный план подготовки к интервью с учетом описания вакансии. Обрати внимание, 
    что в этом плане обязательно должна быть подготовка к вопросам по измененным добавленным частям/навыкам
    потому что кандидат их не знает и не умеет делать.
    
    Отвечай структурированно, как можно короче, по делу, профессионально.

    Отдельно в конце напиши процент вероятности, с которой кандидат сможет получить эту работу. Не делай заглавие,
    просто напиши вероятность в формате:

    ---30%
    `
    try { const adaptedResumeCompletion = await openai.chat.completions.create({
      model: AI_MODEL,
      messages: [
          {
            role: "system",
            content: `${system_prompt}`
          },
          { 
            role: "user", 
            content: `${resume}`
          },
          { 
              role: "user", 
              content: `${vacancy}`
          }
      ],
      temperature: TEMPERATURE
    });
    const adaptedResume = adaptedResumeCompletion.choices[0].message.content;

    const recommendationsCompletion = await openai.chat.completions.create({
      model: AI_MODEL,
      messages: [
          {
            role: "system",
            content: `${system_prompt}`
          },
          { 
            role: "user", 
            content: `${resume}`
          },
          { 
              role: "user", 
              content: `${vacancy}`
          },
          {
            role:"assistant",
            content: `${adaptedResume}`
          },
          {
            role: "user",
            content: `${recommendations_prompt}`
          }
      ],
      temperature: TEMPERATURE
    });
    let recommendationsAndChances = recommendationsCompletion.choices[0].message.content || '';
    let parts = recommendationsAndChances.split('---');
    let recommendations = formatAIResponse(parts[0]?.trim() || '');
    let chances = parts[1]?.trim() || '';

    return Response.json({
      adaptedResume: adaptedResume || '',
      recommendations: recommendations || '',
      chances: chances || ''
    });
  } catch(error) {
    return Response.json({ error: 'Ошибка' }, { status: 500 });
  }
  
}